<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broadcast Landing</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; color: #111; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { font-size: 24px; margin-bottom: 16px; }
        form { border: 1px solid #e5e7eb; padding: 16px; border-radius: 8px; margin-bottom: 24px; }
        label { display: block; font-weight: 600; margin-top: 12px; margin-bottom: 6px; }
        select, input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; }
        button { background: #111827; color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; margin-top: 12px; }
        button:hover { background: #374151; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .muted { color: #6b7280; font-size: 14px; }
        .progress { height: 8px; background: #e5e7eb; border-radius: 999px; overflow: hidden; margin-top: 8px; }
        .progress > span { display: block; height: 100%; width: 0%; background: #10b981; transition: width .2s ease; }
    </style>
    <script>
        async function postJSON(url, data) {
            const resp = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const js = await resp.json();
            if (!resp.ok || js.ok === false) throw new Error(js.error || js.description || 'Request failed');
            return js;
        }

        async function sendText(evt) {
            evt.preventDefault();
            const botId = document.getElementById('bot').value;
            const text = document.getElementById('text').value.trim();
            if (!botId || !text) return alert('Select bot and enter text');
            try {
                const btn = document.getElementById('send_text_btn');
                const prev = btn ? btn.innerText : '';
                if (btn) { btn.disabled = true; btn.innerText = 'Sending…'; }
                const js = await postJSON('/hub/broadcast_action/', { bot_id: Number(botId), action: 'text', text });
                alert('Text broadcast sent to ' + js.sent + ' users (failed: ' + js.failed + ')');
                if (btn) { btn.disabled = false; btn.innerText = prev; }
            } catch (e) { alert(e.message); }
        }

        async function sendPhoto(evt) {
            evt.preventDefault();
            const botId = document.getElementById('bot').value;
            const photo = document.getElementById('photo').value.trim();
            const photoPath = document.getElementById('photo_path') ? document.getElementById('photo_path').value.trim() : '';
            const caption = document.getElementById('caption').value.trim();
            if (!botId || !photo) return alert('Select bot and enter photo URL');
            try {
                const btn = document.getElementById('send_photo_btn');
                const prev = btn ? btn.innerText : '';
                if (btn) { btn.disabled = true; btn.innerText = 'Sending…'; }
                const js = await postJSON('/hub/broadcast_action/', { bot_id: Number(botId), action: 'photo', photo, photo_path: photoPath, caption });
                const err = (js.failures && js.failures[0] && js.failures[0].error) ? ('\nError: ' + js.failures[0].error) : '';
                alert('Photo broadcast sent to ' + js.sent + ' users (failed: ' + js.failed + ')' + err);
                if (btn) { btn.disabled = false; btn.innerText = prev; }
            } catch (e) { alert(e.message); }
        }

        async function sendAndPin(evt) {
            evt.preventDefault();
            const botId = document.getElementById('bot').value;
            const pinText = document.getElementById('pin_text').value.trim();
            if (!botId || !pinText) return alert('Select bot and enter text');
            try {
                const btn = document.getElementById('send_pin_btn');
                const prev = btn ? btn.innerText : '';
                if (btn) { btn.disabled = true; btn.innerText = 'Sending…'; }
                const js = await postJSON('/hub/broadcast_action/', { bot_id: Number(botId), action: 'pin', text: pinText });
                alert('Pinned message sent to ' + js.sent + ' users (failed: ' + js.failed + ')');
                if (btn) { btn.disabled = false; btn.innerText = prev; }
            } catch (e) { alert(e.message); }
        }
        function uploadWithProgress(fileInputId, targetInputId, progressId, pathHiddenId) {
            const botId = document.getElementById('bot').value;
            if (!botId) { alert('Select a bot first'); return; }
            const inp = document.getElementById(fileInputId);
            if (!inp.files || !inp.files[0]) { alert('Choose a file'); return; }
            const form = new FormData();
            form.append('file', inp.files[0]);
            const xhr = new XMLHttpRequest();
            const bar = document.getElementById(progressId);
            const inner = bar ? bar.querySelector('span') : null;
            if (inner) inner.style.width = '0%';
            xhr.open('POST', '/hub/upload_photo/', true);
            xhr.withCredentials = true;
            xhr.upload.onprogress = function (e) {
                if (!inner || !e.lengthComputable) return;
                const pct = Math.round((e.loaded / e.total) * 100);
                inner.style.width = pct + '%';
            };
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    try {
                        const js = JSON.parse(xhr.responseText || '{}');
                        if (xhr.status >= 200 && xhr.status < 300 && js.ok) {
                            document.getElementById(targetInputId).value = js.url;
                            if (pathHiddenId) {
                                document.getElementById(pathHiddenId).value = js.path || '';
                            }
                        } else {
                            alert(js.error || 'Upload failed');
                        }
                    } catch (err) {
                        alert('Upload failed');
                    }
                }
            };
            xhr.send(form);
        }
        function uploadPhotoFile() { uploadWithProgress('file', 'photo', 'photo_progress', 'photo_path'); }
        function uploadVideoFile() { uploadWithProgress('video_file', 'video_url', 'video_progress', 'video_path'); }
        function uploadDocumentFile() { uploadWithProgress('document_file', 'document_url', 'document_progress', 'document_path'); }
        function copyToClipboard(inputId) {
            const val = document.getElementById(inputId).value.trim();
            if (!val) { alert('No URL to copy'); return; }
            navigator.clipboard.writeText(val).then(() => alert('Copied')).catch(() => alert('Copy failed'));
        }
        function openInNewTab(inputId) {
            const val = document.getElementById(inputId).value.trim();
            if (!val) { alert('No URL'); return; }
            window.open(val, '_blank');
        }
        async function sendVideo(evt) {
            evt.preventDefault();
            const botId = document.getElementById('bot').value;
            const video = document.getElementById('video_url').value.trim();
            const videoPath = document.getElementById('video_path').value.trim();
            const caption = document.getElementById('video_caption').value.trim();
            if (!botId || !video) return alert('Select bot and enter video URL');
            try {
                const btn = document.getElementById('send_video_btn');
                const prev = btn.innerText;
                btn.disabled = true; btn.innerText = 'Sending…';
                const js = await postJSON('/hub/broadcast_action/', { bot_id: Number(botId), action: 'video', video, video_path: videoPath, caption });
                const err = (js.failures && js.failures[0] && js.failures[0].error) ? ('\nError: ' + js.failures[0].error) : '';
                alert('Video broadcast sent to ' + js.sent + ' users (failed: ' + js.failed + ')' + err);
                btn.disabled = false; btn.innerText = prev;
            } catch (e) { alert(e.message); }
        }
        async function sendDocument(evt) {
            evt.preventDefault();
            const botId = document.getElementById('bot').value;
            const docUrl = document.getElementById('document_url').value.trim();
            const documentPath = document.getElementById('document_path').value.trim();
            const caption = document.getElementById('document_caption').value.trim();
            if (!botId || (!docUrl && !documentPath)) return alert('Select a bot and provide a document URL or upload a file');
            try {
                const btn = document.getElementById('send_document_btn');
                const prev = btn ? btn.innerText : '';
                if (btn) { btn.disabled = true; btn.innerText = 'Sending ...'; }
                const js = await postJSON('/hub/broadcast_action/', { bot_id: Number(botId), action: 'document', document: docUrl, document_path: documentPath, caption });
                const err = (js.failures && js.failures[0] && js.failures[0].error) ? ('\nError: ' + js.failures[0].error) : '';
                alert('Document broadcast sent to ' + js.sent + ' users (failed: ' + js.failed + ')' + err);
                if (btn) { btn.disabled = false; btn.innerText = prev; }
            } catch (e) { alert(e.message); }
        }
        async function sendToChat(evt) {
            evt.preventDefault();
            const botId = document.getElementById('bot').value;
            const chatId = document.getElementById('chat_id').value.trim();
            const text = document.getElementById('chat_text').value.trim();
            if (!botId || !chatId || !text) return alert('Bot, chat id and text are required');
            try {
                const btn = document.getElementById('send_reply_btn');
                const prev = btn ? btn.innerText : '';
                if (btn) { btn.disabled = true; btn.innerText = 'Sending…'; }
                const js = await postJSON('/hub/send_to_chat/', { bot_id: Number(botId), chat_id: chatId, text });
                alert('Sent');
                if (btn) { btn.disabled = false; btn.innerText = prev; }
            } catch (e) { alert(e.message); }
        }
        async function updateBotProfile(evt) {
            evt.preventDefault();
            const botId = document.getElementById('bot').value;
            const name = document.getElementById('bot_name').value.trim();
            try {
                const resp = await fetch(`/hub/bots/${botId}/update_profile/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                const js = await resp.json();
                if (!resp.ok || js.ok === false) throw new Error(js.error || 'Update failed');
                document.getElementById('bot_name_display').innerText = js.bot.name;
                alert('Saved');
            } catch (e) { alert(e.message); }
        }
        async function syncBotProfileToTelegram() {
            const botId = document.getElementById('bot').value;
            const name = document.getElementById('bot_name').value.trim();
            const description = '';
            const short_description = document.getElementById('bot_short_description').value.trim();
            try {
                const resp = await fetch(`/hub/bots/${botId}/sync_profile/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, short_description })
                });
                const js = await resp.json();
                if (!resp.ok || js.ok === false) throw new Error(js.error || 'Sync failed');
                alert('Synced to Telegram. Note: profile photo must be changed via @BotFather.');
            } catch (e) { alert(e.message); }
        }
    </script>
    {% csrf_token %}
  </head>
  <body>
    <div class="container">
        <h1>Broadcast Center</h1>
        <p class="muted">Send text, photos, or pinned messages to all users of a bot.</p>

        {% if bot %}
            <input type="hidden" id="bot" value="{{ bot.id }}" />
            <div style="display:flex; gap:16px; align-items:flex-start;">
                <div>
                    <p><strong>Bot:</strong> <span id="bot_name_display">{{ bot.name }}</span> (…{{ bot.token|slice:'-4:' }})</p>
                    {% if bot.description %}
                      <p id="bot_desc_display" class="muted">{{ bot.description }}</p>
                    {% else %}
                      <p id="bot_desc_display" class="muted"></p>
                    {% endif %}
                    <p><a href="{% if bot.token %}/hub/logs/token/{{ bot.token }}/{% else %}/hub/logs/{{ bot.id }}/{% endif %}" target="_blank">View Message Logs</a> · <a href="{% if bot.token %}/hub/logs/token/{{ bot.token }}/pdf/{% else %}/hub/logs/{{ bot.id }}/pdf/{% endif %}" target="_blank">Download PDF</a></p>
                </div>
                <div>
                    {% if bot.image_url %}
                      <img id="bot_image_display" src="{{ bot.image_url }}" alt="Bot image" style="max-width:140px; border-radius:8px; border:1px solid #eee;" />
                    {% else %}
                      <img id="bot_image_display" alt="Bot image" style="display:none; max-width:140px; border-radius:8px; border:1px solid #eee;" />
                    {% endif %}
                </div>
            </div>
            <!-- <form onsubmit="updateBotProfile(event)" style="margin-top: 8px;">
                <h3>Bot Profile</h3>
                <label for="bot_name">Name</label>
                <input id="bot_name" type="text" value="{{ bot.name }}" />
                <button type="submit">Save Name</button>
                <div style="margin-top:8px;">
                    <label for="bot_short_description">Short description (120 chars)</label>
                    <input id="bot_short_description" type="text" maxlength="120" placeholder="Shown on the bot profile" />
                    <button type="button" onclick="syncBotProfileToTelegram()" style="margin-top:8px;">Sync to Telegram</button>
                </div>
            </form> -->
        {% else %}
            <label for="bot">Bot</label>
            <select id="bot">
                <option value="">Select a bot</option>
                {% for b in bots %}
                <option value="{{ b.id }}">{{ b.name }} (…{{ b.token|slice:'-4:' }})</option>
                {% endfor %}
            </select>
        {% endif %}

        <div class="grid" style="margin-top: 16px;">
            <form onsubmit="sendText(event)">
                <h3>Send Text</h3>
                <label for="text">Message</label>
                <textarea id="text" rows="4" placeholder="Type your broadcast text..."></textarea>
                <button id="send_text_btn" type="submit">Send Text</button>
            </form>

            <form onsubmit="sendPhoto(event)">
                <h3>Send Photo</h3>
                <label for="photo">Photo URL</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <input id="photo" type="text" placeholder="https://example.com/image.jpg" />
                    <button type="button" onclick="copyToClipboard('photo')">Copy</button>
                    <button type="button" onclick="openInNewTab('photo')">Open</button>
                </div>
                <div style="margin-top:8px;">
                    <input id="file" type="file" accept="image/*" />
                    <button type="button" onclick="uploadPhotoFile()" style="margin-left:8px;">Upload file</button>
                    <div id="photo_progress" class="progress" style="max-width: 240px;"><span></span></div>
                </div>
                <label for="caption">Caption (optional)</label>
                <input id="caption" type="text" placeholder="Caption for the photo" />
                <input id="photo_path" type="hidden" />
                <button id="send_photo_btn" type="submit">Send Photo</button>
            </form>
        </div>

        <form onsubmit="sendVideo(event)" style="margin-top: 16px;">
            <h3>Send Video</h3>
            <label for="video_url">Video URL</label>
            <div style="display:flex; gap:8px; align-items:center;">
                <input id="video_url" type="text" placeholder="https://example.com/video.mp4" />
                <button type="button" onclick="copyToClipboard('video_url')">Copy</button>
                <button type="button" onclick="openInNewTab('video_url')">Open</button>
            </div>
            <div style="margin-top:8px;">
                <input id="video_file" type="file" accept="video/*" />
                <button type="button" onclick="uploadVideoFile()" style="margin-left:8px;">Upload file</button>
                <div id="video_progress" class="progress" style="max-width: 240px;"><span></span></div>
            </div>
            <label for="video_caption">Caption (optional)</label>
            <input id="video_caption" type="text" placeholder="Caption for the video" />
            <input id="video_path" type="hidden" />
            <button id="send_video_btn" type="submit">Send Video</button>
        </form>

        <form onsubmit="sendAndPin(event)" style="margin-top: 16px;">
            <h3>Send & Pin Message</h3>
            <label for="pin_text">Text to pin</label>
            <textarea id="pin_text" rows="3" placeholder="Message to pin in chats..."></textarea>
            <button id="send_pin_btn" type="submit">Send & Pin</button>
        </form>
        <form onsubmit="sendDocument(event)" style="margin-top: 16px;">
            <h3>Send Document</h3>
            <label for="document_url">Document URL</label>
            <div style="display:flex; gap:8px; align-items:center;">
                <input id="document_url" type="text" placeholder="https://example.com/file.pdf" />
                <button type="button" onclick="copyToClipboard('document_url')">Copy</button>
                <button type="button" onclick="openInNewTab('document_url')">Open</button>
            </div>
            <div style="margin-top:8px;">
                <input id="document_file" type="file" />
                <button type="button" onclick="uploadDocumentFile()" style="margin-left:8px;">Upload file</button>
                <div id="document_progress" class="progress" style="max-width: 240px;"><span></span></div>
            </div>
            <label for="document_caption">Caption (optional)</label>
            <input id="document_caption" type="text" placeholder="Caption for the file" />
            <input id="document_path" type="hidden" />
            <button id="send_document_btn" type="submit">Send Document</button>
        </form>
        <form onsubmit="sendToChat(event)" style="margin-top: 16px;">
            <h3>Reply to a Specific Chat</h3>
            <label for="chat_id">Chat ID</label>
            <input id="chat_id" type="text" placeholder="Telegram chat ID (e.g., 123456789)" />
            <label for="chat_text">Message</label>
            <textarea id="chat_text" rows="3" placeholder="Type your reply..."></textarea>
            <button id="send_reply_btn" type="submit">Send Reply</button>
        </form>
    </div>
  </body>
 </html>


